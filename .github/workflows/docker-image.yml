name: Build and Publish Image

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # 允许手动触发
    inputs:
      push_to_dockerhub:
        description: 'Push to Docker Hub?'
        required: false
        default: false
        type: boolean

env:
  # --- 1. 配置区 (Configuration) ---
  
  # 自定义镜像名称 (例如: vps-monitor-pro)
  # 最终地址会是: ghcr.io/用户名/自定义名
  IMAGE_NAME: template-resource-monitor-prince

  # 是否推送到 Docker Hub (默认关闭，设为 true 开启)
  # 也可以在 Secrets 中设置 ENABLE_DOCKERHUB = true 来开启
  ENABLE_DOCKERHUB: false 

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 1. 拉取代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 准备 Docker 环境
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3. 登录 GitHub Packages (GHCR) - 始终执行
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. 登录 Docker Hub (仅当开启时执行)
      # 需要在仓库 Settings -> Secrets 中配置 DOCKER_USERNAME 和 DOCKER_TOKEN
      - name: Log in to Docker Hub
        if: ${{ env.ENABLE_DOCKERHUB == 'true' || inputs.push_to_dockerhub == true }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 5. 生成标签 (Tags)
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          # 这里定义了两个目标：GHCR 和 Docker Hub
          images: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
            ${{ env.ENABLE_DOCKERHUB == 'true' && format('{0}/{1}', secrets.DOCKER_USERNAME, env.IMAGE_NAME) || '' }}
          tags: |
            type=raw,value=latest
            type=sha,format=short

      # 6. 构建并推送
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
